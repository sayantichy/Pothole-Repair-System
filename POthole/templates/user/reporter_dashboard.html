{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-end mb-3">
  <a class="btn btn-outline-danger btn-sm" href="{{ url_for('auth.logout') }}">Logout</a>
</div>

<div class="hero mb-4">
  <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3">
    <div>
      <h1 class="display-6 mb-2">My Reporting Dashboard</h1>
      <p class="text-muted mb-3">Report potholes, track repair progress, and manage your wallet.</p>
      <div class="d-flex gap-2">
        <a class="btn btn-primary" href="{{ url_for('public.report') }}">Report a Pothole</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('public.home') }}">City Overview</a>
      </div>
    </div>

    <div class="card border-0 shadow-sm" style="min-width: 320px;">
      <div class="card-body">
        <h5 class="card-title mb-2">Track by ID</h5>
        <form method="post" action="{{ url_for('public.track_lookup') }}" class="d-flex gap-2">
          <input class="form-control" name="tracking_id" placeholder="e.g. 7A3C9F12" required>
          <button class="btn btn-primary">Find</button>
        </form>
        <small class="text-muted">Use the Tracking ID you got after submitting.</small>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Latest My Reports -->
  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-header">Latest my reports</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead><tr><th>Tracking</th><th>Address</th><th>Size</th><th>Status</th><th>Photos</th><th></th></tr></thead>
          <tbody>
            {% for it in latest %}
              {% set p = it.pothole %}
              <tr>
                <td>{{ p.public_id }}</td>
                <td>{{ p.street_address }}</td>
                <td>{{ p.size_1_10 }}</td>
                <td>
                  {% set c = 'secondary' %}
                  {% if p.status == 'repaired' %}{% set c = 'success' %}
                  {% elif p.status == 'in_progress' %}{% set c = 'warning' %}
                  {% elif p.status in ['temporary','not_repaired'] %}{% set c = 'danger' %}{% endif %}
                  <span class="badge text-bg-{{ c }}">{{ p.status }}</span>
                </td>
                <td>
                  <div class="d-flex flex-wrap thumb-row">
                    {% for ph in it.photos[:3] %}
                      <a href="{{ url_for('public.uploaded_file', filename=ph.filename) }}" target="_blank" title="Open photo">
                        <img class="thumb" src="{{ url_for('public.uploaded_file', filename=ph.filename) }}" alt="photo">
                      </a>
                    {% endfor %}
                    {% if it.photos|length == 0 %}
                      <span class="text-muted">â€”</span>
                    {% endif %}
                  </div>
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('public.track', public_id=p.public_id) }}">View</a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="6" class="text-muted p-3">You havenâ€™t submitted any reports yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Stats + Wallet -->
  <div class="col-12 col-lg-5">
    <div class="row g-3">
      <div class="col-6">
        <div class="card stat-card"><div class="card-body">
          <div class="text-muted">Total reports</div>
          <div class="display-6">{{ stats.total }}</div>
        </div></div>
      </div>
      <div class="col-6">
        <div class="card stat-card"><div class="card-body">
          <div class="text-muted">In progress</div>
          <div class="display-6">{{ stats.in_progress }}</div>
        </div></div>
      </div>
      <div class="col-6">
        <div class="card stat-card"><div class="card-body">
          <div class="text-muted">Repaired</div>
          <div class="display-6">{{ stats.repaired }}</div>
        </div></div>
      </div>
      <div class="col-6">
        <div class="card stat-card"><div class="card-body">
          <div class="text-muted">Waiting</div>
          <div class="display-6">{{ stats.reported }}</div>
        </div></div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">Wallet</div>
      <div class="card-body">
        <div class="display-6 mb-2">{{ '%.2f'|format(wallet) }} Tk</div>
        <small class="text-muted">You earn 20 Tk for unique pothole reports.</small>
      </div>
    </div>
  </div>
</div>

<!-- Full report + wallet tables -->
<div class="row g-3 mt-1">
  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-header">All my reports</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead><tr><th>Date</th><th>Tracking</th><th>Address</th><th>Status</th><th>Duplicate</th><th>Photos</th><th></th></tr></thead>
          <tbody>
          {% for it in items %}
            {% set r = it.report %}
            {% set p = it.pothole %}
            <tr>
              <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ p.public_id }}</td>
              <td>{{ p.street_address }}</td>
              <td>{{ p.status }}</td>
              <td>{{ 'Yes' if r.is_duplicate else 'No' }}</td>
              <td>
                <div class="d-flex flex-wrap thumb-row">
                  {% for ph in it.photos[:5] %}
                    <a href="{{ url_for('public.uploaded_file', filename=ph.filename) }}" target="_blank">
                      <img class="thumb" src="{{ url_for('public.uploaded_file', filename=ph.filename) }}" alt="photo">
                    </a>
                  {% endfor %}
                  {% if it.photos|length == 0 %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </div>
              </td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('public.track', public_id=p.public_id) }}">Track</a>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="7" class="text-muted p-3">No reports yet.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card">
      <div class="card-header">Wallet transactions</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th></tr></thead>
          <tbody>
          {% for t in txs %}
            <tr>
              <td>{{ t.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ t.description }}</td>
              <td>{{ t.type }}</td>
              <td>{{ '%.2f'|format(t.amount if t.type=='credit' else -t.amount) }}</td>
            </tr>
          {% else %}
            <tr><td colspan="4" class="text-muted p-3">No transactions yet.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}





